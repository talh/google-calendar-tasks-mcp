import { writeFileSync } from "node:fs";

// ============================================================
// Workflow 05: Email Sync
// ============================================================

const code05_format = `const fs = require('fs');

const emails = $input.all();
const now = new Date();
const timeStr = now.toISOString().replace('T', ' ').substring(0, 19);

const validEmails = emails.filter(e => e.json.id);

let markdown = '# Inbox Cache\\n*Last synced: ' + timeStr + '*\\n\\n';

if (validEmails.length === 0) {
  markdown += '## No recent emails\\n\\n*Inbox is empty or no emails in the last 24 hours.*\\n\\n';
} else {
  markdown += '## Unprocessed Emails (' + validEmails.length + ' messages)\\n\\n';
  markdown += '| # | From | Subject | Date | Labels |\\n';
  markdown += '|---|------|---------|------|--------|\\n';

  for (let i = 0; i < validEmails.length; i++) {
    const e = validEmails[i].json;
    const from = String(e.from || 'Unknown').substring(0, 60);
    const subject = String(e.subject || 'No subject').substring(0, 80);
    let date = '';
    if (e.date) {
      try { date = new Date(e.date).toISOString().replace('T', ' ').substring(0, 16); } catch(x) { date = String(e.date); }
    }
    const labels = (e.labelIds || []).join(', ');
    markdown += '| ' + (i + 1) + ' | ' + from + ' | ' + subject + ' | ' + date + ' | ' + labels + ' |\\n';
  }

  markdown += '\\n';
}

markdown += '---\\n*Do not edit this file manually. Changes will be overwritten by n8n sync.*\\n';

fs.writeFileSync('/data/DPA/email/inbox_cache.md', markdown, 'utf8');

return [{ json: { success: true, message: 'Email cache synced', emailCount: validEmails.length } }];`;

const workflow05 = {
  name: "DPA - Email Sync",
  nodes: [
    {
      parameters: {
        rule: { interval: [{ field: "minutes", minutesInterval: 15 }] }
      },
      id: "f5e8c1d2-4a3b-4f7e-9c8d-1a2b3c4d5001",
      name: "Every 15 Minutes",
      type: "n8n-nodes-base.scheduleTrigger",
      typeVersion: 1.2,
      position: [0, 0]
    },
    {
      parameters: {
        resource: "message",
        operation: "getAll",
        returnAll: false,
        limit: 50,
        filters: { q: "in:inbox newer_than:1d" },
        options: {}
      },
      id: "f5e8c1d2-4a3b-4f7e-9c8d-1a2b3c4d5002",
      name: "Fetch Inbox Emails",
      type: "n8n-nodes-base.gmail",
      typeVersion: 2.1,
      position: [220, 0],
      credentials: {
        gmailOAuth2: { id: "CONFIGURE_ME", name: "Gmail account" }
      }
    },
    {
      parameters: { jsCode: code05_format },
      id: "f5e8c1d2-4a3b-4f7e-9c8d-1a2b3c4d5003",
      name: "Format and Write Cache",
      type: "n8n-nodes-base.code",
      typeVersion: 2,
      position: [440, 0]
    }
  ],
  pinData: {},
  connections: {
    "Every 15 Minutes": {
      main: [[{ node: "Fetch Inbox Emails", type: "main", index: 0 }]]
    },
    "Fetch Inbox Emails": {
      main: [[{ node: "Format and Write Cache", type: "main", index: 0 }]]
    }
  },
  active: false,
  settings: { executionOrder: "v1", availableInMCP: false },
  meta: {
    instanceId: "db15ded1e67df28bc3ad17568a435a08bfe5decdf96eb303adae31adafba0272"
  },
  tags: [{ name: "DPA" }]
};

// ============================================================
// Workflow 06: Urgent Email Monitor
// ============================================================

const code06_readState = `const fs = require('fs');

let state = { lastCheckedEpoch: 0 };
try {
  const content = fs.readFileSync('/data/DPA/email/.urgent_state.json', 'utf8');
  state = JSON.parse(content);
} catch (e) {
  // First run or file missing - check last 1 hour
  state.lastCheckedEpoch = Math.floor(Date.now() / 1000) - 3600;
}

const query = 'in:inbox after:' + state.lastCheckedEpoch;

return [{ json: { query: query, lastCheckedEpoch: state.lastCheckedEpoch } }];`;

const code06_checkUrgency = `const fs = require('fs');

const emails = $input.all();
const now = new Date();
const timeStr = now.toISOString().replace('T', ' ').substring(0, 19);

const securityKeywords = ['password reset', 'suspicious', 'unauthorized', 'fraud', 'security alert', 'breach', 'compromised', 'verify your account'];
const deadlineKeywords = ['due today', 'expires today', 'last chance', 'action required', 'final notice'];
const meetingChangeKeywords = ['cancelled', 'rescheduled', 'changed', 'updated invitation'];
const familySenders = [];

const alerts = [];

for (const email of emails) {
  const e = email.json;
  if (!e.id) continue;

  const from = String(e.from || '').toLowerCase();
  const subject = String(e.subject || '').toLowerCase();
  const body = String(e.textPlain || '').toLowerCase().substring(0, 2000);
  const combined = subject + ' ' + body;

  let urgencyType = null;
  let urgencyLevel = null;
  let action = null;

  for (const kw of securityKeywords) {
    if (combined.includes(kw)) {
      urgencyType = 'SECURITY';
      urgencyLevel = 'HIGH';
      action = 'DO NOT click links in this email. Go to the service directly.';
      break;
    }
  }

  if (!urgencyType) {
    for (const kw of deadlineKeywords) {
      if (combined.includes(kw)) {
        urgencyType = 'DEADLINE';
        urgencyLevel = 'HIGH';
        action = 'Review the deadline and take action if needed.';
        break;
      }
    }
  }

  if (!urgencyType) {
    for (const kw of meetingChangeKeywords) {
      if (combined.includes(kw) && (from.includes('calendar') || from.includes('google') || subject.includes('invitation'))) {
        urgencyType = 'MEETING';
        urgencyLevel = 'MEDIUM';
        action = 'Review calendar changes.';
        break;
      }
    }
  }

  if (!urgencyType && familySenders.length > 0) {
    for (const familyEmail of familySenders) {
      if (from.includes(familyEmail.toLowerCase())) {
        urgencyType = 'FAMILY';
        urgencyLevel = 'MEDIUM';
        action = 'Check message from family member.';
        break;
      }
    }
  }

  if (urgencyType) {
    alerts.push({
      timestamp: timeStr,
      type: urgencyType,
      level: urgencyLevel,
      from: e.from || 'Unknown',
      subject: e.subject || 'No subject',
      action: action,
      messageId: e.id
    });
  }
}

if (alerts.length > 0) {
  let alertMd = '# Urgent Email Alerts\\n*Last checked: ' + timeStr + '*\\n\\n## Pending Alerts\\n\\n';

  try {
    const existing = fs.readFileSync('/data/DPA/email/urgent_alerts.md', 'utf8');
    const parts = existing.split('## Pending Alerts');
    if (parts[1]) {
      const existingAlerts = parts[1].split('*Alerts are cleared')[0].trim();
      if (existingAlerts) {
        alertMd += existingAlerts + '\\n\\n';
      }
    }
  } catch (e) {}

  for (const alert of alerts) {
    alertMd += '### [' + alert.timestamp + '] ' + alert.type + ': ' + alert.subject + '\\n';
    alertMd += '- **From:** ' + alert.from + '\\n';
    alertMd += '- **Subject:** ' + alert.subject + '\\n';
    alertMd += '- **Urgency:** ' + alert.level + ' \\u2014 ' + alert.type.toLowerCase() + ' alert\\n';
    alertMd += '- **Action:** ' + alert.action + '\\n\\n';
  }

  alertMd += '*Alerts are cleared after being acknowledged in a DPA session.*\\n';
  fs.writeFileSync('/data/DPA/email/urgent_alerts.md', alertMd, 'utf8');
}

const newState = {
  lastCheckedEpoch: Math.floor(Date.now() / 1000),
  lastCheckedAt: timeStr,
  alertsGenerated: alerts.length
};
fs.writeFileSync('/data/DPA/email/.urgent_state.json', JSON.stringify(newState, null, 2) + '\\n', 'utf8');

return [{ json: { success: true, emailsChecked: emails.length, alertsGenerated: alerts.length } }];`;

const workflow06 = {
  name: "DPA - Email Urgent Monitor",
  nodes: [
    {
      parameters: {
        rule: { interval: [{ field: "minutes" }] }
      },
      id: "f5e8c1d2-4a3b-4f7e-9c8d-2a2b3c4d6001",
      name: "Every 5 Minutes",
      type: "n8n-nodes-base.scheduleTrigger",
      typeVersion: 1.2,
      position: [0, 0]
    },
    {
      parameters: { jsCode: code06_readState },
      id: "f5e8c1d2-4a3b-4f7e-9c8d-2a2b3c4d6002",
      name: "Read Last Check State",
      type: "n8n-nodes-base.code",
      typeVersion: 2,
      position: [220, 0]
    },
    {
      parameters: {
        resource: "message",
        operation: "getAll",
        returnAll: false,
        limit: 50,
        filters: { q: "={{ $json.query }}" },
        options: {}
      },
      id: "f5e8c1d2-4a3b-4f7e-9c8d-2a2b3c4d6003",
      name: "Fetch New Emails",
      type: "n8n-nodes-base.gmail",
      typeVersion: 2.1,
      position: [440, 0],
      credentials: {
        gmailOAuth2: { id: "CONFIGURE_ME", name: "Gmail account" }
      }
    },
    {
      parameters: { jsCode: code06_checkUrgency },
      id: "f5e8c1d2-4a3b-4f7e-9c8d-2a2b3c4d6004",
      name: "Check Urgency and Write Alerts",
      type: "n8n-nodes-base.code",
      typeVersion: 2,
      position: [660, 0]
    }
  ],
  pinData: {},
  connections: {
    "Every 5 Minutes": {
      main: [[{ node: "Read Last Check State", type: "main", index: 0 }]]
    },
    "Read Last Check State": {
      main: [[{ node: "Fetch New Emails", type: "main", index: 0 }]]
    },
    "Fetch New Emails": {
      main: [[{ node: "Check Urgency and Write Alerts", type: "main", index: 0 }]]
    }
  },
  active: false,
  settings: { executionOrder: "v1", availableInMCP: false },
  meta: {
    instanceId: "db15ded1e67df28bc3ad17568a435a08bfe5decdf96eb303adae31adafba0272"
  },
  tags: [{ name: "DPA" }]
};

// ============================================================
// Workflow 07: Email Action Pickup (native Gmail nodes)
// ============================================================

const code07_readPending = `const fs = require('fs');

let data = { pending: [], synced: [] };
try {
  const content = fs.readFileSync('/data/DPA/email/pending_actions.json', 'utf8');
  data = JSON.parse(content);
} catch (e) {
  data = { pending: [], synced: [] };
}

const pending = data.pending || [];

if (pending.length > 0) {
  return pending.map(function(action) {
    // Normalize unsubscribe to archive (both remove INBOX)
    var type = action.type;
    if (type === 'unsubscribe') type = 'archive';

    return {
      json: {
        type: type,
        messageId: action.messageId,
        subject: action.subject || '',
        addLabelIds: action.addLabels || [],
        removeLabelIds: action.removeLabels || [],
        originalAction: action
      }
    };
  });
} else {
  return [{ json: { noPending: true, type: 'none' } }];
}`;

const code07_updateFile = `const fs = require('fs');

const items = $input.all();
const now = new Date().toISOString();

let data = { pending: [], synced: [] };
try {
  const content = fs.readFileSync('/data/DPA/email/pending_actions.json', 'utf8');
  data = JSON.parse(content);
} catch (e) {
  data = { pending: [], synced: [] };
}

var processed = 0;
var errors = 0;

for (const item of items) {
  const j = item.json;

  if (j.error) {
    errors++;
    continue;
  }

  // Gmail API returns 'id', Code node sets 'messageId'
  const messageId = j.id || j.messageId;
  if (!messageId) continue;

  const idx = (data.pending || []).findIndex(function(a) { return a.messageId === messageId; });
  if (idx >= 0) {
    const action = data.pending.splice(idx, 1)[0];
    data.synced = data.synced || [];
    action.syncedAt = now;
    data.synced.push(action);
    processed++;
  }
}

fs.writeFileSync('/data/DPA/email/pending_actions.json', JSON.stringify(data, null, 2) + '\\n', 'utf8');

return [{ json: { success: true, processed: processed, errors: errors } }];`;

const gmailCreds = { gmailOAuth2: { id: "CONFIGURE_ME", name: "Gmail account" } };

const workflow07 = {
  name: "DPA - Email Action Pickup",
  nodes: [
    {
      parameters: {
        rule: { interval: [{ field: "minutes" }] }
      },
      id: "f5e8c1d2-4a3b-4f7e-9c8d-3a2b3c4d7001",
      name: "Every 5 Minutes",
      type: "n8n-nodes-base.scheduleTrigger",
      typeVersion: 1.2,
      position: [0, 0]
    },
    {
      parameters: { jsCode: code07_readPending },
      id: "f5e8c1d2-4a3b-4f7e-9c8d-3a2b3c4d7002",
      name: "Read Pending Actions",
      type: "n8n-nodes-base.code",
      typeVersion: 2,
      position: [220, 0]
    },
    {
      parameters: {
        conditions: {
          options: { caseSensitive: true, leftValue: "", typeValidation: "strict", version: 1 },
          conditions: [
            {
              leftValue: "={{ $json.type }}",
              rightValue: "none",
              operator: { type: "string", operation: "notEquals" },
              id: "cond-action-type"
            }
          ],
          combinator: "and"
        },
        options: {}
      },
      id: "f5e8c1d2-4a3b-4f7e-9c8d-3a2b3c4d7003",
      name: "Has Pending Actions?",
      type: "n8n-nodes-base.if",
      typeVersion: 2,
      position: [440, 0]
    },
    // --- Switch: route by action type ---
    {
      parameters: {
        rules: {
          values: [
            {
              conditions: {
                conditions: [{
                  leftValue: "={{ $json.type }}",
                  rightValue: "archive",
                  operator: { type: "string", operation: "equals" }
                }],
                combinator: "and"
              },
              renameOutput: true,
              outputKey: "Archive"
            },
            {
              conditions: {
                conditions: [{
                  leftValue: "={{ $json.type }}",
                  rightValue: "trash",
                  operator: { type: "string", operation: "equals" }
                }],
                combinator: "and"
              },
              renameOutput: true,
              outputKey: "Trash"
            },
            {
              conditions: {
                conditions: [{
                  leftValue: "={{ $json.type }}",
                  rightValue: "label",
                  operator: { type: "string", operation: "equals" }
                }],
                combinator: "and"
              },
              renameOutput: true,
              outputKey: "Label"
            }
          ]
        },
        options: {}
      },
      id: "f5e8c1d2-4a3b-4f7e-9c8d-3a2b3c4d7004",
      name: "Route by Action Type",
      type: "n8n-nodes-base.switch",
      typeVersion: 3,
      position: [660, 0]
    },
    // --- Gmail: Archive (remove INBOX label) ---
    {
      parameters: {
        resource: "message",
        operation: "removeLabels",
        messageId: "={{ $json.messageId }}",
        labelIds: ["INBOX"]
      },
      id: "f5e8c1d2-4a3b-4f7e-9c8d-3a2b3c4d7005",
      name: "Archive Email",
      type: "n8n-nodes-base.gmail",
      typeVersion: 2.1,
      position: [900, -160],
      credentials: gmailCreds
    },
    // --- Gmail: Trash (add TRASH label) ---
    {
      parameters: {
        resource: "message",
        operation: "addLabels",
        messageId: "={{ $json.messageId }}",
        labelIds: ["TRASH"]
      },
      id: "f5e8c1d2-4a3b-4f7e-9c8d-3a2b3c4d7006",
      name: "Trash Email",
      type: "n8n-nodes-base.gmail",
      typeVersion: 2.1,
      position: [900, 0],
      credentials: gmailCreds
    },
    // --- Gmail: Add Labels (dynamic from pending action) ---
    {
      parameters: {
        resource: "message",
        operation: "addLabels",
        messageId: "={{ $json.messageId }}",
        labelIds: "={{ $json.addLabelIds }}"
      },
      id: "f5e8c1d2-4a3b-4f7e-9c8d-3a2b3c4d7007",
      name: "Add Labels",
      type: "n8n-nodes-base.gmail",
      typeVersion: 2.1,
      position: [900, 160],
      credentials: gmailCreds
    },
    // --- Update file: move processed items to synced ---
    {
      parameters: { jsCode: code07_updateFile },
      id: "f5e8c1d2-4a3b-4f7e-9c8d-3a2b3c4d7008",
      name: "Update Actions File",
      type: "n8n-nodes-base.code",
      typeVersion: 2,
      position: [1120, 0]
    },
    {
      parameters: {},
      id: "f5e8c1d2-4a3b-4f7e-9c8d-3a2b3c4d7009",
      name: "No Pending Actions",
      type: "n8n-nodes-base.noOp",
      typeVersion: 1,
      position: [660, 240]
    }
  ],
  pinData: {},
  connections: {
    "Every 5 Minutes": {
      main: [[{ node: "Read Pending Actions", type: "main", index: 0 }]]
    },
    "Read Pending Actions": {
      main: [[{ node: "Has Pending Actions?", type: "main", index: 0 }]]
    },
    "Has Pending Actions?": {
      main: [
        [{ node: "Route by Action Type", type: "main", index: 0 }],
        [{ node: "No Pending Actions", type: "main", index: 0 }]
      ]
    },
    "Route by Action Type": {
      main: [
        [{ node: "Archive Email", type: "main", index: 0 }],
        [{ node: "Trash Email", type: "main", index: 0 }],
        [{ node: "Add Labels", type: "main", index: 0 }],
        []
      ]
    },
    "Archive Email": {
      main: [[{ node: "Update Actions File", type: "main", index: 0 }]]
    },
    "Trash Email": {
      main: [[{ node: "Update Actions File", type: "main", index: 0 }]]
    },
    "Add Labels": {
      main: [[{ node: "Update Actions File", type: "main", index: 0 }]]
    }
  },
  active: false,
  settings: { executionOrder: "v1", availableInMCP: false },
  meta: {
    instanceId: "db15ded1e67df28bc3ad17568a435a08bfe5decdf96eb303adae31adafba0272"
  },
  tags: [{ name: "DPA" }]
};

// ============================================================
// Write all workflow files
// ============================================================

const outDir = "D:/Dropbox/DPA/n8n_workflows";

writeFileSync(`${outDir}/05_email_sync.json`, JSON.stringify(workflow05, null, 2) + "\n");
console.log("Created 05_email_sync.json");

writeFileSync(`${outDir}/06_email_urgent_monitor.json`, JSON.stringify(workflow06, null, 2) + "\n");
console.log("Created 06_email_urgent_monitor.json");

writeFileSync(`${outDir}/07_email_action_pickup.json`, JSON.stringify(workflow07, null, 2) + "\n");
console.log("Created 07_email_action_pickup.json");

console.log("\nAll 3 workflow files generated successfully.");
console.log("NOTE: After importing into n8n, configure the Gmail OAuth2 credential (replace CONFIGURE_ME).");
